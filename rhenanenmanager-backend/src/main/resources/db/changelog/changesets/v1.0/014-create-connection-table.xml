<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="014-create-connection-table" author="rhenanenmanager">
        <comment>Create connection table for tracking relationships between Corps members</comment>

        <createTable tableName="connection">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <!-- Relationship endpoints -->
            <column name="from_profile_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="to_profile_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <!-- Connection type and metadata -->
            <column name="relation_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="DATE"/>
            <column name="end_date" type="DATE"/>
            <column name="description" type="TEXT"/>

            <!-- Bidirectional flag -->
            <column name="bidirectional" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <!-- Audit fields (inherited from BaseEntity) -->
            <column name="created" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="DATETIME" defaultValueComputed="CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <!-- User references for audit trail -->
            <column name="created_by_id" type="BIGINT"/>
            <column name="updated_by_id" type="BIGINT"/>
        </createTable>

        <!-- Foreign Keys -->
        <addForeignKeyConstraint
            constraintName="fk_connection_from_profile"
            baseTableName="connection"
            baseColumnNames="from_profile_id"
            referencedTableName="profile"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            constraintName="fk_connection_to_profile"
            baseTableName="connection"
            baseColumnNames="to_profile_id"
            referencedTableName="profile"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            constraintName="fk_connection_created_by"
            baseTableName="connection"
            baseColumnNames="created_by_id"
            referencedTableName="user"
            referencedColumnNames="id"
            onDelete="SET NULL"/>

        <addForeignKeyConstraint
            constraintName="fk_connection_updated_by"
            baseTableName="connection"
            baseColumnNames="updated_by_id"
            referencedTableName="user"
            referencedColumnNames="id"
            onDelete="SET NULL"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_connection_from_profile" tableName="connection">
            <column name="from_profile_id"/>
        </createIndex>

        <createIndex indexName="idx_connection_to_profile" tableName="connection">
            <column name="to_profile_id"/>
        </createIndex>

        <createIndex indexName="idx_connection_relation_type" tableName="connection">
            <column name="relation_type"/>
        </createIndex>

        <!-- Composite index for checking connection existence -->
        <createIndex indexName="idx_connection_profiles_type" tableName="connection">
            <column name="from_profile_id"/>
            <column name="to_profile_id"/>
            <column name="relation_type"/>
        </createIndex>

        <!-- Index for querying active connections -->
        <createIndex indexName="idx_connection_end_date" tableName="connection">
            <column name="end_date"/>
        </createIndex>

        <rollback>
            <dropTable tableName="connection"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
