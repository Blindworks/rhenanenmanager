<div class="graph-wrapper">
  @if (nodes().length === 0) {
    <div class="empty-state">
      <mat-icon>account_tree</mat-icon>
      <h3>Keine Beziehungen gefunden</h3>
      <p>Fügen Sie Beziehungen hinzu, um sie hier zu visualisieren.</p>
    </div>
  } @else {
    <div
      #graphContainer
      class="graph-container">

      <svg [attr.width]="1200" [attr.height]="800" class="graph-svg">
        <defs>
          @for (type of connectionTypes; track type) {
            <marker
              [attr.id]="'arrowhead-' + type"
              markerWidth="10"
              markerHeight="10"
              refX="25"
              refY="3"
              orient="auto"
              markerUnits="strokeWidth">
              <path d="M0,0 L0,6 L9,3 z" [attr.fill]="connectionTypeColors[type]" />
            </marker>
          }
        </defs>

        <g class="links">
          @for (link of links(); track link.connection.connection.id) {
            <line
              [attr.x1]="link.source.x"
              [attr.y1]="link.source.y"
              [attr.x2]="link.target.x"
              [attr.y2]="link.target.y"
              [attr.stroke]="getLinkColor(link)"
              [attr.stroke-width]="isLinkHighlighted(link) ? 3 : 2"
              [attr.stroke-opacity]="isLinkHighlighted(link) ? 1 : 0.4"
              [attr.marker-end]="'url(#arrowhead-' + link.connection.connection.connectionType + ')'"
              class="link"
              [class.highlighted]="isLinkHighlighted(link)">
            </line>
          }
        </g>

        <g class="nodes">
          @for (node of nodes(); track node.id) {
            <g
              [attr.transform]="'translate(' + node.x + ',' + node.y + ')'"
              class="node"
              [class.selected]="selectedNode() === node"
              [class.highlighted]="isNodeHighlighted(node)"
              (click)="onNodeClick(node)"
              (mouseenter)="onNodeMouseEnter(node)"
              (mouseleave)="onNodeMouseLeave()">

              <circle
                r="30"
                [attr.fill]="node.profile.profileImageUrl ? 'url(#img-' + node.id + ')' : '#1e3a8a'"
                stroke="#fff"
                stroke-width="3"
                class="node-circle" />

              @if (!node.profile.profileImageUrl) {
                <text
                  text-anchor="middle"
                  dy=".3em"
                  fill="white"
                  font-size="14"
                  font-weight="500"
                  class="node-initials">
                  {{ getProfileInitials(node.profile) }}
                </text>
              }
            </g>
          }
        </g>
      </svg>

      <div class="node-cards">
        @for (node of nodes(); track node.id) {
          <div
            class="node-card"
            [class.selected]="selectedNode() === node"
            [class.highlighted]="isNodeHighlighted(node)"
            [class.hovered]="hoveredNode() === node"
            [style.left.px]="node.x - 60"
            [style.top.px]="node.y + 45"
            (click)="onNodeClick(node)">

            <div class="card-content">
              <div class="profile-info">
                <strong>{{ node.profile.firstname }} {{ node.profile.lastname }}</strong>
                @if (node.profile.number) {
                  <span class="profile-number">{{ node.profile.number }}</span>
                }
              </div>
              @if (node.profile.status) {
                <div class="profile-status">{{ node.profile.status }}</div>
              }
            </div>

            @if (selectedNode() === node) {
              <div class="connections-list">
                @for (link of getLinksForNode(node); track link.connection.connection.id) {
                  <div class="connection-item">
                    <div class="connection-header">
                      <mat-icon
                        [style.color]="getLinkColor(link)"
                        class="connection-type-icon">
                        {{ connectionTypeIcons[link.connection.connection.connectionType] }}
                      </mat-icon>
                      <span class="connection-label">
                        {{ connectionTypeLabels[link.connection.connection.connectionType] }}
                      </span>
                    </div>
                    <div class="connection-target">
                      @if (link.source.id === node.id) {
                        → {{ link.target.profile.firstname }} {{ link.target.profile.lastname }}
                      } @else {
                        ← {{ link.source.profile.firstname }} {{ link.source.profile.lastname }}
                      }
                    </div>
                    <div class="connection-actions">
                      <button
                        mat-icon-button
                        (click)="onEditConnection(link.connection); $event.stopPropagation()"
                        matTooltip="Bearbeiten">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="onDeleteConnection(link.connection); $event.stopPropagation()"
                        matTooltip="Löschen">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </div>

    <div class="graph-legend">
      <h4>Legende</h4>
      <div class="legend-items">
        @for (type of connectionTypes; track type) {
          <div class="legend-item">
            <div class="legend-color" [style.background-color]="connectionTypeColors[type]"></div>
            <mat-icon class="legend-icon">{{ connectionTypeIcons[type] }}</mat-icon>
            <span>{{ connectionTypeLabels[type] }}</span>
          </div>
        }
      </div>
      <div class="legend-hint">
        <mat-icon>info</mat-icon>
        <span>Klicken Sie auf einen Knoten, um Details und Beziehungen anzuzeigen.</span>
      </div>
    </div>
  }
</div>
