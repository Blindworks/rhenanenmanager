<div class="graph-wrapper">
  @if (nodes().length === 0) {
    <div class="empty-state">
      <mat-icon>account_tree</mat-icon>
      <h3>Keine Beziehungen gefunden</h3>
      <p>Fügen Sie Beziehungen hinzu, um sie hier zu visualisieren.</p>
    </div>
  } @else {
    <div
      #graphContainer
      class="graph-container">

      <svg [attr.width]="1400" [attr.height]="900" class="graph-svg">
        <defs>
          @for (type of connectionTypes; track type) {
            <marker
              [attr.id]="'arrowhead-' + type"
              markerWidth="10"
              markerHeight="10"
              refX="150"
              refY="3"
              orient="auto"
              markerUnits="strokeWidth">
              <path d="M0,0 L0,6 L9,3 z" [attr.fill]="connectionTypeColors[type]" />
            </marker>
          }
        </defs>

        <g class="links">
          @for (link of links(); track link.connection.connection.id) {
            <line
              [attr.x1]="link.source.x + 90"
              [attr.y1]="link.source.y + 50"
              [attr.x2]="link.target.x + 90"
              [attr.y2]="link.target.y + 50"
              [attr.stroke]="getLinkColor(link)"
              [attr.stroke-width]="isLinkHighlighted(link) ? 3 : 2"
              [attr.stroke-opacity]="isLinkHighlighted(link) ? 1 : 0.4"
              [attr.marker-end]="'url(#arrowhead-' + link.connection.connection.connectionType + ')'"
              class="link"
              [class.highlighted]="isLinkHighlighted(link)">
            </line>
          }
        </g>
      </svg>

      <div class="node-cards">
        @for (node of nodes(); track node.id) {
          <mat-card
            class="node-card"
            [class.selected]="selectedNode() === node"
            [class.highlighted]="isNodeHighlighted(node)"
            [class.hovered]="hoveredNode() === node"
            [style.left.px]="node.x"
            [style.top.px]="node.y"
            (click)="onNodeClick(node)"
            (mouseenter)="onNodeMouseEnter(node)"
            (mouseleave)="onNodeMouseLeave()">

            <div class="card-header">
              <div class="profile-avatar">
                @if (node.profile.profileImageUrl) {
                  <img [src]="node.profile.profileImageUrl" [alt]="node.profile.firstname + ' ' + node.profile.lastname">
                } @else {
                  <div class="avatar-placeholder">
                    {{ getProfileInitials(node.profile) }}
                  </div>
                }
              </div>
              <div class="profile-details">
                <div class="profile-name">
                  {{ node.profile.firstname }} {{ node.profile.lastname }}
                  @if (node.profile.number) {
                    <span class="profile-number">#{{ node.profile.number }}</span>
                  }
                </div>
                @if (node.profile.status) {
                  <div class="profile-status">
                    <mat-icon>label</mat-icon>
                    {{ node.profile.status }}
                  </div>
                }
              </div>
            </div>

            @if (selectedNode() === node) {
              <mat-divider></mat-divider>
              <div class="connections-list">
                <div class="connections-header">
                  <mat-icon>account_tree</mat-icon>
                  <span>Beziehungen ({{ getLinksForNode(node).length }})</span>
                </div>
                @for (link of getLinksForNode(node); track link.connection.connection.id) {
                  <div class="connection-item">
                    <div class="connection-info">
                      <mat-icon
                        [style.color]="getLinkColor(link)"
                        class="connection-type-icon">
                        {{ connectionTypeIcons[link.connection.connection.connectionType] }}
                      </mat-icon>
                      <div class="connection-details">
                        <span class="connection-label">
                          {{ connectionTypeLabels[link.connection.connection.connectionType] }}
                        </span>
                        <span class="connection-target">
                          @if (link.source.id === node.id) {
                            → {{ link.target.profile.firstname }} {{ link.target.profile.lastname }}
                          } @else {
                            ← {{ link.source.profile.firstname }} {{ link.source.profile.lastname }}
                          }
                        </span>
                      </div>
                    </div>
                    <div class="connection-actions">
                      <button
                        mat-icon-button
                        (click)="onEditConnection(link.connection); $event.stopPropagation()"
                        matTooltip="Bearbeiten">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="onDeleteConnection(link.connection); $event.stopPropagation()"
                        matTooltip="Löschen">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </mat-card>
        }
      </div>
    </div>

    <div class="graph-legend">
      <h4>Legende</h4>
      <div class="legend-items">
        @for (type of connectionTypes; track type) {
          <div class="legend-item">
            <div class="legend-color" [style.background-color]="connectionTypeColors[type]"></div>
            <mat-icon class="legend-icon">{{ connectionTypeIcons[type] }}</mat-icon>
            <span>{{ connectionTypeLabels[type] }}</span>
          </div>
        }
      </div>
      <div class="legend-hint">
        <mat-icon>info</mat-icon>
        <span>Klicken Sie auf einen Knoten, um Details und Beziehungen anzuzeigen.</span>
      </div>
    </div>
  }
</div>
